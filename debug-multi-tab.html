<!DOCTYPE html>
<html>
<head>
    <title>Multi-Tab WebSocket Debug</title>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <h1>Multi-Tab WebSocket Debug</h1>
    <div id="status">Connecting...</div>
    <div id="logs"></div>
    
    <button onclick="joinRoom()">Join Attendance Room</button>
    <button onclick="sendUpdate()">Send Test Update</button>
    <button onclick="clearLogs()">Clear Logs</button>

    <script>
        const tabId = Math.random().toString(36).substr(2, 9);
        let socket = null;
        
        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toISOString().substr(11, 12);
            logs.innerHTML += `<div>[${timestamp}] [Tab ${tabId}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[Tab ${tabId}] ${message}`);
        }
        
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
            log(`Status: ${status}`);
        }
        
        // Connect to WebSocket
        function connect() {
            socket = io('http://localhost:3001', {
                auth: {
                    userId: 2,
                    email: 'isaac@redeemercc.org.au',
                    role: 'admin',
                    churchId: '1'
                },
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', () => {
                updateStatus(`Connected - Socket ID: ${socket.id}`);
            });
            
            socket.on('disconnect', (reason) => {
                updateStatus(`Disconnected: ${reason}`);
            });
            
            socket.on('joined_attendance', (data) => {
                log(`✅ Joined room: ${data.roomName} with ${data.activeUsers.length} users`);
            });
            
            socket.on('attendance_update', (update) => {
                log(`📊 Received attendance update: ${JSON.stringify(update)}`);
            });
            
            socket.on('attendance_update_success', () => {
                log(`✅ Attendance update confirmed`);
            });
            
            socket.on('attendance_update_error', (error) => {
                log(`❌ Attendance update error: ${error.message}`);
            });
            
            socket.on('user_joined', (activity) => {
                log(`👋 User joined: ${activity.userEmail}`);
            });
            
            socket.on('room_users_updated', (update) => {
                log(`👥 Room users updated: ${update.activeUsers.length} users`);
            });
        }
        
        function joinRoom() {
            if (!socket) {
                log('❌ Not connected');
                return;
            }
            
            log('📋 Joining attendance room...');
            socket.emit('join_attendance', {
                gatheringId: 1,
                date: '2025-08-24'
            });
        }
        
        function sendUpdate() {
            if (!socket) {
                log('❌ Not connected');
                return;
            }
            
            const individualId = Math.floor(Math.random() * 10) + 1;
            const present = Math.random() > 0.5;
            
            log(`📤 Sending attendance update: Individual ${individualId} = ${present}`);
            socket.emit('record_attendance', {
                gatheringId: 1,
                date: '2025-08-24',
                records: [{ individualId, present }]
            });
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        // Auto-connect on page load
        window.onload = () => {
            connect();
            
            // Auto-join room after a short delay
            setTimeout(() => {
                joinRoom();
            }, 2000);
        };
    </script>
</body>
</html>
